<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- Seu head permanece igual -->
    <!-- Inclui Tailwind CSS, SQL.js, etc. -->
</head>
<body class="bg-dark-800 text-white">
    <!-- Navegação e conteúdo principal -->
    <!-- ... (mantém todo o HTML existente) ... -->

    <!-- Botão para atualizar o banco -->
    <button onclick="refreshDatabaseFromDrive()" 
            class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
        Atualizar Banco (Google Drive)
    </button>

    <!-- Novo botão para exportar o banco -->
    <button onclick="exportDatabase()" 
            class="mt-4 ml-2 px-4 py-2 gold-bg hover:bg-gold-600 text-dark-900 rounded-lg">
        Exportar Banco Atualizado
    </button>

    <!-- Script principal -->
    <script>
        // Variável global para armazenar o ID do arquivo no Google Drive
        const GOOGLE_DRIVE_DB_URL = 'https://drive.google.com/file/d/1yhknBes8yKADIUZc08szJJfUCGQHQqkA/view?usp=drive_link';

        let db;
        let isAuthenticated = false;

        // Função para inicializar o banco de dados
        async function initDatabase() {
            try {
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/ ${file}`
                });

                let dbArrayBuffer;

                // Tenta carregar do localStorage primeiro
                const savedDb = localStorage.getItem('localDB');
                if (savedDb) {
                    dbArrayBuffer = new Uint8Array(JSON.parse(savedDb));
                } else {
                    // Se não tiver local, baixa do Google Drive
                    const response = await fetch(GOOGLE_DRIVE_DB_URL);
                    dbArrayBuffer = new Uint8Array(await response.arrayBuffer());
                }

                db = new SQL.Database(dbArrayBuffer);

                console.log("Banco carregado com sucesso!");
            } catch (err) {
                alert("Erro ao carregar o banco de dados.");
                console.error(err);
            }
        }

        // Função para exportar o banco como arquivo
        window.exportDatabase = function () {
            const data = db.export(); // Uint8Array
            const blob = new Blob([data], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'banco.sqlite';
            a.click();
            URL.revokeObjectURL(url);
        };

        // Função para atualizar o banco a partir do Google Drive
        window.refreshDatabaseFromDrive = async function () {
            if (!confirm('Tem certeza que deseja recarregar o banco do Google Drive? Todos os dados locais serão substituídos.')) {
                return;
            }

            try {
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/ ${file}`
                });

                const response = await fetch(GOOGLE_DRIVE_DB_URL);
                const dbArrayBuffer = new Uint8Array(await response.arrayBuffer());

                db = new SQL.Database(dbArrayBuffer);

                // Salva no localStorage também
                localStorage.setItem('localDB', JSON.stringify(Array.from(dbArrayBuffer)));

                alert("Banco atualizado com sucesso!");

                // Atualiza as listas
                renderProducts();
                renderAdminProducts();

            } catch (err) {
                alert("Erro ao atualizar o banco do Google Drive.");
                console.error(err);
            }
        };

        // Modificação na função saveDatabase()
        function saveDatabase() {
            if (db) {
                const data = db.export();
                localStorage.setItem('localDB', JSON.stringify(Array.from(data)));
            }
        }

        // Atualize suas funções CRUD para chamar saveDatabase()
        function addProduct(product) {
            const stmt = db.prepare(`
                INSERT INTO products (name, price, description, image_url, purchase_link)
                VALUES (?, ?, ?, ?, ?)
            `);
            stmt.bind([
                product.name,
                product.price,
                product.description,
                product.image_url,
                product.purchase_link
            ]);
            stmt.step();
            stmt.free();
            saveDatabase();
            return db.exec("SELECT last_insert_rowid()")[0].values[0][0];
        }

        function updateProduct(product) {
            const stmt = db.prepare(`
                UPDATE products 
                SET name = ?, price = ?, description = ?, image_url = ?, purchase_link = ?
                WHERE id = ?
            `);
            stmt.bind([
                product.name,
                product.price,
                product.description,
                product.image_url,
                product.purchase_link,
                product.id
            ]);
            stmt.step();
            stmt.free();
            saveDatabase();
        }

        function deleteProductById(id) {
            const stmt = db.prepare("DELETE FROM products WHERE id = ?");
            stmt.bind([id]);
            stmt.step();
            stmt.free();
            saveDatabase();
        }

        // Inicialização do app
        async function init() {
            await initDatabase();
            setupEventListeners();
            renderProducts();
            renderAdminProducts();
        }

        // Execute a inicialização
        init();
    </script>
</body>
</html>
